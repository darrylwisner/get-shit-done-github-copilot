# Upstream Sync Workflow
# Detects changes in upstream gsd-build/get-shit-done, merges them,
# regenerates the Copilot wrapper layer, verifies it, and creates/updates a PR.
#
# One-time prerequisite: create GitHub labels before first run:
#   gh label create upstream-sync --color 0075ca --description "Upstream sync PR"
#   gh label create automated --color e4e669 --description "Automated workflow"
#
# To enable daily schedule, uncomment the schedule block below.

# on:
#   schedule:
#     - cron: '0 6 * * *'  # Daily at 06:00 UTC

on:
  workflow_dispatch:
  push:
    branches:
      - 'copilot/**'

name: Upstream Sync

concurrency:
  group: upstream-sync
  cancel-in-progress: false

env:
  UPSTREAM_REPO: gsd-build/get-shit-done
  UPSTREAM_BRANCH: main
  DEFAULT_BRANCH: main

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout fork (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git" || true
          git fetch upstream "${{ env.UPSTREAM_BRANCH }}"

      - name: Detect upstream changes
        id: detect
        run: |
          FORK_HEAD=$(git rev-parse HEAD)
          UPSTREAM_HEAD=$(git rev-parse "upstream/${{ env.UPSTREAM_BRANCH }}")
          SHORT_SHA=$(git rev-parse --short "upstream/${{ env.UPSTREAM_BRANCH }}")

          echo "fork_head=$FORK_HEAD" >> "$GITHUB_OUTPUT"
          echo "upstream_head=$UPSTREAM_HEAD" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

          # Check if upstream has commits not in fork HEAD
          DIFF_COUNT=$(git rev-list HEAD..upstream/${{ env.UPSTREAM_BRANCH }} --count)
          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            echo "No upstream changes detected. Exiting."
          else
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
            echo "Detected $DIFF_COUNT new upstream commit(s)."
          fi

      - name: Exit silently if no changes
        if: steps.detect.outputs.no_changes == 'true'
        run: exit 0

      - name: Create/reset working branch
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          git checkout -B automated/upstream-sync origin/${{ env.DEFAULT_BRANCH }}

      - name: Merge upstream changes
        if: steps.detect.outputs.no_changes != 'true'
        id: merge
        run: |
          if ! git merge "upstream/${{ env.UPSTREAM_BRANCH }}" --no-edit; then
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U | tr '\n' '\n- ' | sed 's/^/- /')
            cat > /tmp/issue-body.md << 'ISSUE_EOF'
          ## Upstream Sync Merge Conflict

          The automated upstream sync encountered a merge conflict and could not complete.

          **Upstream commit:** ${{ steps.detect.outputs.short_sha }}
          **Upstream HEAD:** ${{ steps.detect.outputs.upstream_head }}
          **Fork HEAD (before merge):** ${{ steps.detect.outputs.fork_head }}

          ### Conflicting files
          ISSUE_EOF
            git diff --name-only --diff-filter=U | sed 's/^/- /' >> /tmp/issue-body.md
            cat >> /tmp/issue-body.md << 'ISSUE_EOF'

          ### Resolution steps
          1. Check out the `automated/upstream-sync` branch locally
          2. Resolve conflicts manually
          3. Run `node scripts/generate-prompts.mjs && node scripts/verify-prompts.mjs`
          4. Push and open PR manually

          **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ISSUE_EOF
            gh issue create \
              --repo "$GITHUB_REPOSITORY"
              --title "Upstream sync merge conflict (upstream@${{ steps.detect.outputs.short_sha }})" \
              --body-file /tmp/issue-body.md \
              --label "upstream-sync"
            exit 1
          fi

      - name: Run prompt generator
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          node scripts/generate-prompts.mjs > /tmp/gen_output.txt 2>&1
          echo "Generator output:"
          cat /tmp/gen_output.txt

      - name: Run prompt verifier
        if: steps.detect.outputs.no_changes != 'true'
        id: verify
        run: |
          if ! node scripts/verify-prompts.mjs > /tmp/ver_output.txt 2>&1; then
            cat > /tmp/issue-body.md << 'ISSUE_EOF'
          ## Upstream Sync Verifier Failure

          The upstream sync completed merge and regeneration, but the verifier failed. No PR was created.

          **Upstream commit:** ${{ steps.detect.outputs.short_sha }}
          **Upstream HEAD:** ${{ steps.detect.outputs.upstream_head }}

          ### Generator output
          ```
          ISSUE_EOF
            cat /tmp/gen_output.txt >> /tmp/issue-body.md
            cat >> /tmp/issue-body.md << 'ISSUE_EOF'
          ```

          ### Verifier output
          ```
          ISSUE_EOF
            cat /tmp/ver_output.txt >> /tmp/issue-body.md
            cat >> /tmp/issue-body.md << 'ISSUE_EOF'
          ```

          ### Resolution steps
          1. Review the verifier errors above
          2. Fix `scripts/generate-prompts.mjs` or `scripts/verify-prompts.mjs` as needed (do NOT edit upstream content)
          3. Re-run workflow or fix and push manually

          **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ISSUE_EOF
            gh issue create \
              --repo "$GITHUB_REPOSITORY"
              --title "Upstream sync verifier failed (upstream@${{ steps.detect.outputs.short_sha }})" \
              --body-file /tmp/issue-body.md \
              --label "upstream-sync"
            exit 1
          fi
          echo "Verifier passed."
          cat /tmp/ver_output.txt

      - name: Commit regenerated wrapper files
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          git add .github/prompts/ .github/agents/ .github/instructions/ || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: regenerate Copilot wrapper layer for upstream@${{ steps.detect.outputs.short_sha }}"
          else
            echo "No wrapper file changes to commit."
          fi

      - name: Force-push working branch
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          git push --force-with-lease origin automated/upstream-sync

      - name: Build PR body
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          RANGE="${{ steps.detect.outputs.fork_head }}...${{ steps.detect.outputs.upstream_head }}"
          CHANGED_FILES=$(git diff --name-only "${{ steps.detect.outputs.fork_head }}" "${{ steps.detect.outputs.upstream_head }}" -- commands/gsd/ get-shit-done/ agents/ 2>/dev/null | sed 's/^/- /' || echo "- (none detected)")

          cat > /tmp/pr-body.md << PR_EOF
          ## Upstream sync from \`gsd-build/get-shit-done\`

          **Upstream commit:** \`${{ steps.detect.outputs.short_sha }}\`
          **Commit range:** \`${RANGE}\`

          ### Changed upstream files
          ${CHANGED_FILES}

          ### Copilot wrapper layer
          ✅ Generator and verifier passed. Wrapper files regenerated automatically.

          ---
          *This PR was created automatically by the upstream-sync workflow.*
          *See [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.*
          PR_EOF

      - name: Create or update PR
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          SHORT_SHA="${{ steps.detect.outputs.short_sha }}"
          PR_TITLE="sync: upstream changes from ${SHORT_SHA}"

          EXISTING_PR=$(gh pr list \
            --head "automated/upstream-sync" \
            --state open \
            --json number \
            --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --repo "$GITHUB_REPOSITORY" \
              --base "${{ env.DEFAULT_BRANCH }}" \
              --head "automated/upstream-sync" \
              --title "${PR_TITLE}" \
              --body-file /tmp/pr-body.md \
              --label "upstream-sync" \
              --label "automated"
            echo "Created new PR."
          else
            gh pr edit "$EXISTING_PR" \
              --repo "$GITHUB_REPOSITORY"
              --title "${PR_TITLE}" \
              --body-file /tmp/pr-body.md
            echo "Updated existing PR #${EXISTING_PR}."
          fi

  repair:
    name: Self-Repair (Copilot Agent)
    runs-on: ubuntu-latest
    needs: sync
    if: always() && needs.sync.result != 'skipped'
    timeout-minutes: 90
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      GH_TOKEN: ${{ secrets.COPILOT_PAT }}

    steps:
      - name: Check COPILOT_PAT
        id: preflight
        run: |
          if [ -z "${{ secrets.COPILOT_PAT }}" ]; then
            echo "::warning::COPILOT_PAT secret is not set. Skipping self-repair job."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: steps.preflight.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.COPILOT_PAT }}

      - name: Setup Node
        if: steps.preflight.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch upstream
        if: steps.preflight.outputs.skip != 'true'
        run: |
          git remote add upstream https://github.com/gsd-build/get-shit-done.git 2>/dev/null || true
          git fetch upstream

      - name: Repair loop
        if: steps.preflight.outputs.skip != 'true'
        id: repair_loop
        run: |
          set -euo pipefail

          MAX_ATTEMPTS=3
          ATTEMPT=0
          REPAIR_NEEDED=false
          REPAIR_SUCCEEDED=false
          REPO_OWNER="${GITHUB_REPOSITORY%%/*}"

          # Gather diagnostic context once
          UPSTREAM_DIFF=$(git diff HEAD upstream/main -- . ':(exclude)commands/gsd' ':(exclude)get-shit-done' ':(exclude)agents' 2>/dev/null | head -c 20000 || true)
          GENERATOR_SRC=$(cat scripts/generate-prompts.mjs)
          VERIFIER_SRC=$(cat scripts/verify-prompts.mjs)

          # Run initial verify to see if repair is needed
          if node scripts/verify-prompts.mjs > /tmp/verify_initial.log 2>&1; then
            echo "Verifier passed — no repair needed."
            echo "repair_needed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          REPAIR_NEEDED=true
          INITIAL_ERRORS=$(cat /tmp/verify_initial.log | head -c 5000)

          build_repair_prompt() {
            local attempt=$1
            local prior_patches=""
            if [ "$attempt" -ge 2 ] && [ -f /tmp/patch_attempt_1.diff ]; then
              prior_patches="\n\n## Failed Patch — Attempt 1\n\`\`\`diff\n$(cat /tmp/patch_attempt_1.diff | head -c 5000)\n\`\`\`"
            fi
            if [ "$attempt" -ge 3 ] && [ -f /tmp/patch_attempt_2.diff ]; then
              prior_patches="${prior_patches}\n\n## Failed Patch — Attempt 2\n\`\`\`diff\n$(cat /tmp/patch_attempt_2.diff | head -c 5000)\n\`\`\`"
            fi

            local framing=""
            if [ "$attempt" -eq 3 ]; then
              framing=" This is the last attempt before human escalation."
            fi

            cat <<PROMPT
          You are the GSD upstream-sync repair agent. Analyze the upstream diff and verifier errors below, then update \`scripts/generate-prompts.mjs\` and/or \`scripts/verify-prompts.mjs\` to make the verifier pass.${framing}

          RULES:
          - NEVER modify files under: commands/gsd/, get-shit-done/, agents/
          - Only edit scripts/ and .github/prompts/ if needed
          - After edits, run: node scripts/generate-prompts.mjs && node scripts/verify-prompts.mjs
          - Open a PR targeting branch: automated/upstream-sync

          ## Verifier Errors
          \`\`\`
          ${INITIAL_ERRORS}
          \`\`\`

          ## Upstream Diff (truncated to 20k chars)
          \`\`\`diff
          ${UPSTREAM_DIFF}
          \`\`\`

          ## scripts/generate-prompts.mjs (current)
          \`\`\`js
          ${GENERATOR_SRC}
          \`\`\`

          ## scripts/verify-prompts.mjs (current)
          \`\`\`js
          ${VERIFIER_SRC}
          \`\`\`
          ${prior_patches}
          PROMPT
          }

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "::group::Repair attempt $ATTEMPT of $MAX_ATTEMPTS"

            PROMPT_TEXT=$(build_repair_prompt "$ATTEMPT")
            printf '%s' "$PROMPT_TEXT" > /tmp/repair_prompt_${ATTEMPT}.txt

            # Invoke Copilot agent (use --body-file to avoid shell escaping issues with JS source)
            gh agent-task create \
              --repo "$GITHUB_REPOSITORY" \
              --base "automated/upstream-sync" \
              --follow \
              --body-file /tmp/repair_prompt_${ATTEMPT}.txt \
              || true

            # Capture what changed
            git diff HEAD > /tmp/patch_attempt_${ATTEMPT}.diff 2>/dev/null || true

            # Check verifier
            if node scripts/verify-prompts.mjs > /tmp/verify_attempt_${ATTEMPT}.log 2>&1; then
              echo "Verifier passed on attempt $ATTEMPT."
              REPAIR_SUCCEEDED=true
              echo "repair_succeeded=true" >> "$GITHUB_OUTPUT"
              echo "repair_needed=true" >> "$GITHUB_OUTPUT"
              echo "::endgroup::"
              break
            else
              echo "::warning::Verifier failed after attempt $ATTEMPT."
              INITIAL_ERRORS=$(cat /tmp/verify_attempt_${ATTEMPT}.log | head -c 5000)
            fi

            echo "::endgroup::"
          done

          # Write final outputs (repair_succeeded written in loop on success; write exhaustion flag here)
          if [ "$REPAIR_SUCCEEDED" = false ] && [ "$REPAIR_NEEDED" = true ]; then
            echo "repair_needed=true" >> "$GITHUB_OUTPUT"
            echo "repair_succeeded=false" >> "$GITHUB_OUTPUT"
            echo "attempts_exhausted=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Filesystem guard (post-repair)
        if: steps.preflight.outputs.skip != 'true' && steps.repair_loop.outputs.repair_needed == 'true'
        run: |
          bash scripts/guard-upstream-files.sh post-commit

      - name: Escalate — Create GitHub issue
        if: >
          steps.preflight.outputs.skip != 'true' &&
          steps.repair_loop.outputs.attempts_exhausted == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
        run: |
          set -euo pipefail
          REPO_OWNER="${GITHUB_REPOSITORY%%/*}"

          # Deduplicate: skip if open sync-failed issue already exists
          EXISTING=$(gh issue list \
            --repo "$GITHUB_REPOSITORY" \
            --label "sync-failed" \
            --state open \
            --json number \
            --jq 'length' 2>/dev/null || echo "0")
          if [ "$EXISTING" -gt 0 ]; then
            echo "::warning::Open sync-failed issue already exists. Skipping duplicate creation."
            exit 0
          fi

          # Build diagnostic dump (respecting 65,536 char limit)
          UPSTREAM_DIFF=$(git diff HEAD upstream/main -- . \
            ':(exclude)commands/gsd' ':(exclude)get-shit-done' ':(exclude)agents' \
            2>/dev/null | head -c 15000 || true)

          PATCH_1=$([ -f /tmp/patch_attempt_1.diff ] && cat /tmp/patch_attempt_1.diff | head -c 8000 || echo "(none)")
          PATCH_2=$([ -f /tmp/patch_attempt_2.diff ] && cat /tmp/patch_attempt_2.diff | head -c 8000 || echo "(none)")
          PATCH_3=$([ -f /tmp/patch_attempt_3.diff ] && cat /tmp/patch_attempt_3.diff | head -c 8000 || echo "(none)")

          VERIFY_LOG=$(cat /tmp/verify_attempt_3.log 2>/dev/null | head -c 4000 || \
                       cat /tmp/verify_initial.log 2>/dev/null | head -c 4000 || echo "(none)")

          cat > /tmp/issue_body.md <<ISSUE
          Self-repair agent failed after 3 attempts on run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).

          @${REPO_OWNER} — manual intervention required.

          ## Summary
          The upstream sync detected changes that broke the compatibility layer (generate-prompts / verify-prompts). The Copilot repair agent was invoked 3 times with escalating context but could not produce a passing verifier run.

          ---

          ## Verifier Output (last attempt)
          \`\`\`
          ${VERIFY_LOG}
          \`\`\`

          ## Upstream Diff (truncated)
          \`\`\`diff
          ${UPSTREAM_DIFF}
          \`\`\`

          ## Patch — Attempt 1
          \`\`\`diff
          ${PATCH_1}
          \`\`\`

          ## Patch — Attempt 2
          \`\`\`diff
          ${PATCH_2}
          \`\`\`

          ## Patch — Attempt 3
          \`\`\`diff
          ${PATCH_3}
          \`\`\`
          ISSUE

          gh issue create \
            --repo "$GITHUB_REPOSITORY" \
            --title "sync-failed: Copilot repair exhausted after 3 attempts (run #${{ github.run_number }})" \
            --label "sync-failed" \
            --body-file /tmp/issue_body.md

  guard:
    name: Filesystem Guard (copilot/* branches)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/copilot/')
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/gsd-build/get-shit-done.git 2>/dev/null || true
          git fetch upstream

      - name: Run filesystem guard
        run: |
          bash scripts/guard-upstream-files.sh post-commit

